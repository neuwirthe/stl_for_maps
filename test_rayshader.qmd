---
title: "test rayshaderstl"
format: html
editor: source
---

```{r}
suppressPackageStartupMessages({
  library(fs)
  library(here)
  library(terra)
  library(rayshader)
  library(rgl)
  library(tictoc)
  library(tidyverse)
})
```

1:10000
1 mm -> 10m 


```{r}
tif_to_print <- "erster_for_stl"
```


```{r}
if(!str_detect(tif_to_print, "\\.tif$")){ 
  tif_to_print <- paste0(tif_to_print,".tif")
}
tif_infile <- path(here(), "tif_for_stl", tif_to_print)
if(!file_exists(tif_infile)) stop(paste(tif_infile, "missing"))
raster <- rast(tif_infile) # SpatRaster
```
```{r}
get_border <- function(obj) {
  flattened <- classify(r, cbind(-Inf, Inf, 1)) # everything = 1
  as.polygons(flattened, na.rm = TRUE) |> # cell polygons[web:108]
    aggregate() # dissolve into one polygon[web:106]
}
```



```{r}
tic()
elmat <- raster_to_matrix(tif_infile)
dim(elmat) ->
  dims
toc()
```


```{r}
par3d(windowRect = c(0, 0, dims[1], dims[2]))
options(rgl.printRglwidget = TRUE)
elmat |>
  sphere_shade(texture = "desert") |>
  plot_3d(elmat, zscale = 1)
render_snapshot()
toc()
```

```{r}
tic()
dims <- dim(elmat)
# par3d(windowRect = c(0, 0, dims[1]/2, dims[2]/2))
options(rgl.printRglwidget = TRUE)
elmat[1:(dims[1]/2),1:(dims[2]/2)] |>
  sphere_shade(texture = "desert") |>
  plot_3d(elmat[1:(dims[1]/2),1:(dims[2]/2)], zscale = 1)
render_snapshot()
toc()
```


```{r}
tic()
dims <- dim(elmat)
# par3d(windowRect = c(0, 0, dims[1]/2, dims[2]/2))
options(rgl.printRglwidget = TRUE)
elmat[1:(dims[1]/2),1:(dims[2]/2)] |>
  sphere_shade(texture = "desert") |>
  plot_3d(elmat[1:(dims[1]/2),1:(dims[2]/2)], zscale = 1)
render_snapshot()
toc()
```



```{r}
tic()
 options(rgl.printRglwidget = TRUE)
 library(rgl)
# open3d()
# par3d(windowRect = c(0, 0, dims[1]/2, dims[2]/2)) 
 elmat_2 <- elmat[1:(dims[1]/2),1:(dims[2]/2)]
 elmat_2_col <- elmat_2 |>
 sphere_shade(texture = "desert") 
  plot_3d(
    heightmap  = elmat_2,
    hillshade = elmat_2_col,
    zscale = 1,
    windowsize=c(800,800))
  rglwidget()
toc()

```





```{r}
tic()
save_3dprint(
  filename = "erster_1.stl", # .stl appended if omitted
  #  filename = "kor_kritz_large.stl",  # .stl appended if omitted
  maxwidth = max(dims_big[1] / 2, dims_big[2] / 2),
  unit = "mm",
  rotate = TRUE
)
toc()
```


```{r}
file_size("erster_large.stl")
```

